{% extends "base.html" %}
{% load static %}

{% block title %}仪表盘{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">仪表盘</h1>
</div>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
{% endif %}

{# ========== 管理员视图 ========== #}
{% if request.user.is_admin %}
<div class="row">
    <div class="col-md-3 mb-4">
        <div class="card text-white bg-primary shadow">
            <div class="card-body">
                <h5 class="card-title">学生总数</h5>
                <p class="card-text fs-4">{{ student_count }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card text-white bg-success shadow">
            <div class="card-body">
                <h5 class="card-title">教师总数</h5>
                <p class="card-text fs-4">{{ teacher_count }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card text-white bg-info shadow">
            <div class="card-body">
                <h5 class="card-title">课程总数</h5>
                <p class="card-text fs-4">{{ course_count }}</p>
            </div>
        </div>
    </div>
     <div class="col-md-3 mb-4">
        <div class="card text-white bg-warning shadow">
            <div class="card-body">
                <h5 class="card-title">院系总数</h5>
                <p class="card-text fs-4">{{ department_count }}</p>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-lg-8 mb-4">
        <div class="card shadow">
            <div class="card-header">课程选修人数统计</div>
            <div class="card-body" style="height: 400px;">
                <canvas id="courseDistributionChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4 mb-4">
        <div class="card shadow">
            <div class="card-header">全校成绩分布</div>
            <div class="card-body" style="height: 400px;">
                <canvas id="gradeDistributionChart"></canvas>
            </div>
        </div>
    </div>
</div>

{# ========== 教师视图 ========== #}
{% elif request.user.is_teacher %}
<h2>我教的课程</h2>
{% if teacher_courses %}
    <ul class="list-group mb-4">
        {% for course in teacher_courses %}
            <li class="list-group-item">{{ course.name }}</li>
        {% endfor %}
    </ul>
{% else %}
    <p>您当前未教授任何课程。</p>
{% endif %}
<div class="row">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header">所教课程成绩分布</div>
            <div class="card-body" style="height: 400px;">
                <canvas id="teacherGradeDistributionChart"></canvas>
            </div>
        </div>
    </div>
</div>

{# ========== 学生视图 ========== #}
{% elif request.user.is_student %}
<h2>我的成绩</h2>
 {% if enrollments %}
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>课程</th>
                <th>成绩</th>
            </tr>
        </thead>
        <tbody>
            {% for enrollment in enrollments %}
                <tr>
                    <td>{{ enrollment.course.name }}</td>
                    <td>{{ enrollment.score }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <div class="alert alert-info">暂无成绩记录。</div>
{% endif %}

{% else %}
    <div class="alert alert-secondary">未知的用户类型，无可用信息。</div>
{% endif %}

{% endblock %}


{% block extra_js %}
{# 使用 json_script 标签安全地传递数据 #}
{% if request.user.is_admin %}
    {{ course_distribution_data|json_script:"course-data" }}
    {{ grade_distribution_data|json_script:"grade-data" }}
{% elif request.user.is_teacher %}
    {{ teacher_grade_distribution_data|json_script:"teacher-grade-data" }}
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const chartColors = [
        'rgba(54, 162, 235, 0.6)', 'rgba(75, 192, 192, 0.6)',
        'rgba(255, 206, 86, 0.6)', 'rgba(255, 159, 64, 0.6)',
        'rgba(153, 102, 255, 0.6)', 'rgba(255, 99, 132, 0.6)'
    ];
    const chartBorderColors = [
        'rgb(54, 162, 235)', 'rgb(75, 192, 192)',
        'rgb(255, 206, 86)', 'rgb(255, 159, 64)',
        'rgb(153, 102, 255)', 'rgb(255, 99, 132)'
    ];

    function renderChart(canvasId, chartType, data, options = {}) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return;

        const chartData = JSON.parse(document.getElementById(data.id)?.textContent || '{}');
        if (!chartData.labels || chartData.labels.length === 0) {
            const canvas = ctx.getContext('2d');
            canvas.font = "16px sans-serif";
            canvas.textAlign = "center";
            canvas.fillText(data.emptyMessage, ctx.width / 2, ctx.height / 2);
            return;
        }

        new Chart(ctx, {
            type: chartType,
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: data.label,
                    data: chartData.data,
                    backgroundColor: chartColors,
                    borderColor: chartBorderColors,
                    borderWidth: 1
                }]
            },
            options: { ...options, responsive: true, maintainAspectRatio: false }
        });
    }

    // 渲染管理员图表
    if (document.getElementById('course-data')) {
        renderChart('courseDistributionChart', 'bar', {
            id: 'course-data',
            label: '选修人数',
            emptyMessage: '暂无课程选修数据'
        }, {
            scales: {
                y: { beginAtZero: true, ticks: { precision: 0 } }
            },
            plugins: { legend: { display: false } }
        });

        renderChart('gradeDistributionChart', 'pie', {
            id: 'grade-data',
            label: '学生人数',
            emptyMessage: '暂无成绩分布数据'
        });
    }
    
    // 渲染教师图表
    if (document.getElementById('teacher-grade-data')) {
        renderChart('teacherGradeDistributionChart', 'pie', {
            id: 'teacher-grade-data',
            label: '学生人数',
            emptyMessage: '暂无您所教课程的成绩数据'
        });
    }
});
</script>
{% endblock %}